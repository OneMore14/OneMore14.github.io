---
layout: post
title:  "Stanford CS251 Cryptocurrencies, blockchains, and smart contracts Tips"
date:   2021-07-02 21:42:01 +0800
categories: 区块链 分布式 
typora-root-url: ../../../
---



Fall 2021  https://cs251.stanford.edu/



Tips:

## lecture1 Intro to cryptography & cryptocurrencies


![picture1](/assets/2021/07/cs251-lecture2-1.png )



CRHF = collision resistant hash function

###  binding commitment

h = Hash(message)

发送方同时给接收方message和message的哈希值h，接收方可以重新计算哈希值验证消息是否被篡改

### proof of work

![image-20220805153956093](/assets/2021/07/cs251-lecture2-2.png)



The difference between Big O notation and Big Ω notation is that Big O is used to describe the worst case running time for an algorithm. But, Big Ω notation, on the other hand, is used to describe the best case running time for a given algorithm.



比特币中满足puzzle的解就叫做nonce



### digital signatures

![image-20220805154518509](/assets/2021/07/cs251-lecture2-3.png)



## lecture2 Bitcoin nuts and bolts 



### bitcoin header

![image-20220805155126728](/assets/2021/07/cs251-lecture2-4.png)

上图中bits就是PoW的difficulty，nonce就是解， time是组装区块的时间(太久远会被reject)



### transaction structure

![image-20220805155434482](/assets/2021/07/cs251-lecture2-5.png)



![image-20220805155756948](/assets/2021/07/cs251-lecture2-6.png)



![image-20220805155940683](/assets/2021/07/cs251-lecture2-7.png)



Bitcoin script use a stack machine，not turing complete, no loops



### Tramsaction types 

无论哪种交易方式，核心思想都是将ScriptSig和ScriptPK拼接起来，然后执行

### 1. P2PKH

P2PKH = pay to public key hash， funding tx通过接收者的公钥哈希(比特币地址)来确保币的流向

ScriptPK_b = DUP HASH256 <addr_b> EQVERIFY CHECKSIG

ScriptSig_b = <sig> <pk_b>

<sig> = Sign(sk_b, Tx)    Tx = Tx_spend excluding all ScriptSigs

执行过程就是上图Example中的脚本，核心是检查b是否有对应的公钥私钥



这种转账方式有问题

![image-20220805162505696](/assets/2021/07/cs251-lecture2-8.png)

这个ECDSA malleability不是特别明白，查了一下https://wiki.bitcoinsv.io/index.php/Transaction_Malleability   ECDSA在已知(m, sig)的情况下可以构造出sig'，使得签名仍然有效，可能是在说这个问题. 

这样会使TX的TXID改变，但也仅仅是txid改变，其他都不变，交易也能正常执行。具体的场景是，如果Alice给Bob发一个BTC，并提前计算出txid(记为txid_a)后告诉了Bob，Bob可以利用这个漏洞修改txid成为txid_b，交易正常进行且Bob收到这个BTC。但Bob可以提出区块中没有txid_a这个交易，声称自己没收到钱，如果Alice一查确实没有txid_a，然后再不仔细核对的话，就可能重复给Bob发另一个BTC. 具体看下这个 https://eklitzke.org/bitcoin-transaction-malleability  





### 2. P2SH

P2SH = pay to script hash， funding tx把币转到一个脚本的哈希值，而不是公钥的哈希值

ScriptPK = HASH160 <H(redeem script)> EQUAL

ScriptSig = <sig1> <sig2> ... <sig_n> <redeem script>



可以支持multisig， 比如2-out-of-3:

<2> <PK1> <PK2> <PK3> <3> CHECKMULTISIG  只需要有任意两个sig是能验证的就好

